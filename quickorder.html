<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Espacio Raro - Formulario de Pedido</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    #product-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-6">
        <h3>Formulario de Cliente</h3>
        <form id="client-form">
          <div class="mb-3">
            <label for="fullName" class="form-label">Nombre completo</label>
            <input type="text" class="form-control" id="fullName" required />
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">Dirección</label>
            <input type="text" class="form-control" id="address" required />
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Correo electrónico</label>
            <input type="email" class="form-control" id="email" required />
          </div>
          <div class="mb-3">
            <label for="rut" class="form-label">RUT (sin puntos ni guión)</label>
            <input type="text" class="form-control" id="rut" placeholder="12345678K" required />
          </div>
          <div class="mb-3">
            <label for="message" class="form-label">Mensaje adicional</label>
            <textarea class="form-control" id="message" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="image" class="form-label">Subir imagen</label>
            <input type="file" class="form-control" id="image" accept="image/*" />
          </div>
          <div class="mb-3">
            <label for="productType" class="form-label">Producto</label>
            <select class="form-select" id="productType" required>
              <option value="">-- Selecciona un producto --</option>
              <option value="camiseta">Camiseta</option>
              <option value="chaqueta">Chaqueta</option>
              <option value="taza">Taza</option>
            </select>
          </div>
          <button type="button" class="btn btn-secondary mb-3" id="addToOrder">Agregar al pedido</button>
          <button type="submit" class="btn btn-primary">Enviar pedido actual</button>
        </form>
        <div id="status" class="mt-3"></div>
      </div>

      <div class="col-md-6 text-center">
        <h4 class="mb-3">Vista previa del producto</h4>
        <img id="product-image" src="" alt="Selecciona un producto para ver la imagen" class="d-none"/>
      </div>
    </div>

    <div id="crud-container" class="mt-5 d-none">
      <h4>Lista de Pedidos</h4>
      <table class="table table-bordered" id="orderTable">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Dirección</th>
            <th>Email</th>
            <th>RUT</th>
            <th>Producto</th>
            <th>Mensaje</th>
            <th>Imagen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-success" id="sendAllOrders">Enviar todos los pedidos por email</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init('9e5qncGaLfZ2nHK8R'); // Tu User ID de EmailJS

    const productImages = {
      camiseta: 'ballena.png',
      chaqueta: 'leiya.png',
      taza: 'cup.png'
    };

    const emailInput = document.getElementById('email');
    const rutInput = document.getElementById('rut');
    const imageInput = document.getElementById('image');
    const productSelect = document.getElementById('productType');
    const productImage = document.getElementById('product-image');
    const statusDiv = document.getElementById('status');

    let pedidos = [];
    let editingIndex = null;

    productSelect.addEventListener('change', () => {
      const selected = productSelect.value;
      if (productImages[selected]) {
        productImage.src = productImages[selected];
        productImage.classList.remove('d-none');
      } else {
        productImage.src = '';
        productImage.classList.add('d-none');
      }
    });

    function validarEmail(email) {
      return /^[^\s@]+@[^\s@]+\.(com|cl)$/.test(email);
    }

    function validarRut(rut) {
      rut = rut.replace(/\./g, '').replace('-', '').toUpperCase();
      
      if (!/^\d{7,8}[0-9K]$/.test(rut)) return false;

      const cuerpo = rut.slice(0, -1);
      const dvIngresado = rut.slice(-1);

      if (/^(\d)\1+$/.test(cuerpo)) return false; // evita todos iguales

      let suma = 0, multiplicador = 2;
      for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo.charAt(i)) * multiplicador;
        multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
      }

      const residuo = 11 - (suma % 11);
      let dvEsperado;
      if (residuo === 11) dvEsperado = '0';
      else if (residuo === 10) dvEsperado = 'K';
      else dvEsperado = residuo.toString();

      return dvEsperado === dvIngresado;
    }

    function validarImagen(file) {
      if (!file) return true;
      const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
      return validTypes.includes(file.type);
    }

    async function uploadImageToImgur(file) {
      const clientId = '4ce38bc681386af';
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: { Authorization: 'Client-ID ' + clientId },
        body: formData,
      });
      const data = await response.json();
      if (data.success) return data.data.link;
      else throw new Error('Error al subir imagen a Imgur');
    }

    document.getElementById('addToOrder').addEventListener('click', async () => {
      statusDiv.textContent = '';
      const fullName = document.getElementById('fullName').value.trim();
      const address = document.getElementById('address').value.trim();
      const email = emailInput.value.trim();
      const rut = rutInput.value.trim();
      const message = document.getElementById('message').value.trim();
      const product = productSelect.value;
      const imageFile = imageInput.files[0];

      if (!validarEmail(email)) return alert("Correo inválido.");
      if (!validarRut(rut)) return alert("RUT chileno no válido.");
      if (!validarImagen(imageFile)) return alert("Imagen no válida.");
      if (message === '' && !imageFile && editingIndex === null) return alert("Debe ingresar un mensaje o imagen.");

      let imageUrl = '';
      try {
        if (imageFile) imageUrl = await uploadImageToImgur(imageFile);
        else if (editingIndex !== null) imageUrl = pedidos[editingIndex].imageUrl;
      } catch (error) {
        alert("Error al subir la imagen: " + error.message);
        return;
      }

      const pedido = { fullName, address, email, rut, message, product, imageUrl };
      if (editingIndex !== null) pedidos[editingIndex] = pedido;
      else pedidos.push(pedido);

      renderTablaPedidos();
      document.getElementById('client-form').reset();
      productImage.classList.add('d-none');
      editingIndex = null;
    });

    function renderTablaPedidos() {
      const tbody = document.querySelector('#orderTable tbody');
      tbody.innerHTML = '';
      pedidos.forEach((p, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.fullName}</td>
          <td>${p.address}</td>
          <td>${p.email}</td>
          <td>${p.rut}</td>
          <td>${p.product}</td>
          <td>${p.message}</td>
          <td>${p.imageUrl ? `<a href="${p.imageUrl}" target="_blank">Ver</a>` : 'Sin imagen'}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editarPedido(${index})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarPedido(${index})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById('crud-container').classList.toggle('d-none', pedidos.length === 0);
    }

    function editarPedido(index) {
      const p = pedidos[index];
      document.getElementById('fullName').value = p.fullName;
      document.getElementById('address').value = p.address;
      document.getElementById('email').value = p.email;
      document.getElementById('rut').value = p.rut;
      document.getElementById('message').value = p.message;
      document.getElementById('productType').value = p.product;
      if (productImages[p.product]) {
        productImage.src = productImages[p.product];
        productImage.classList.remove('d-none');
      }
      editingIndex = index;
      statusDiv.textContent = 'Editando pedido...';
    }

    function eliminarPedido(index) {
      if (confirm("¿Estás seguro de eliminar este pedido?")) {
        pedidos.splice(index, 1);
        renderTablaPedidos();
      }
    }

    document.getElementById('client-form').addEventListener('submit', function (e) {
      e.preventDefault();
      alert("Este botón envía solo el pedido actual ingresado. Use el botón verde para enviar todos.");
    });

    document.getElementById('sendAllOrders').addEventListener('click', async () => {
      if (pedidos.length === 0) return alert("No hay pedidos que enviar.");

      statusDiv.innerHTML = '<p>Enviando pedidos... <span class="spinner-border spinner-border-sm"></span></p>';
      const feedback = [];

      const promises = pedidos.map((p, i) => {
        const templateParams = {
          from_name: p.fullName,
          from_email: p.email,
          rut: p.rut,
          address: p.address,
          product: p.product,
          message: p.message || '(sin mensaje)',
          image_url: p.imageUrl || 'Sin imagen',
          subject: `Pedido #${i + 1} de ${p.fullName}`
        };

        return emailjs.send('service_g4hcubg', 'template_uc8dtuj', templateParams)
          .then(() => {
            feedback.push(`<li class="text-success">✅ Pedido #${i + 1} enviado correctamente.</li>`);
          })
          .catch((error) => {
            feedback.push(`<li class="text-danger">❌ Pedido #${i + 1} falló: ${error.text || error}</li>`);
          });
      });

      Promise.all(promises).then(() => {
        statusDiv.innerHTML = `
          <p class="fw-bold">Resultado del envío:</p>
          <ul>${feedback.join('')}</ul>
        `;
        pedidos = [];
        renderTablaPedidos();
        document.getElementById('client-form').reset();
        productImage.classList.add('d-none');
      });
    });
  </script>
</body>
</html>
